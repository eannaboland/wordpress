var UpdraftPlus_Remote_Communications=function(e,t){return this.version="0.3.3 (27/July/2016)",this.key_name_indicator="",this.key_remote=!1,this.key_local=!1,this.can_generate=!1,this.destination_url=!1,this.maximum_replay_time_difference=300,this.extra_replay_protection=!1,this.debug_level=0,this.seen_hashes={},this.cors_headers_wanted=1,this.format=2,this.time_correction_sec=0,this.http_credentials={},this.auth_method="jquery",this.message_wrapper=!1,this.message_unwrapper=!1,this.message_random_number=!1,e="undefined"!=typeof e?e:"default",t="undefined"!=typeof t&&t,this.time_now=function(){var e=Math.floor(Date.now()/1e3)+this.time_correction_sec;return e},this.register_time=function(e){if("undefined"!=typeof e){var t=Math.floor(Date.now()/1e3),s=e-t;Math.abs(s)>120&&(console.log("UDRPC: Time difference detected; time_now="+t+", server_time="+e+", store_diff="+s),this.time_correction_sec=s)}},this.paddingleft=function(e,t){return String(e+t).slice(-e.length)},this.set_key_name_indicator=function(e){this.key_name_indicator=e},this.set_cors_headers_wanted=function(e){e="undefined"==typeof e||e,this.cors_headers_wanted=e},this.set_can_generate=function(e){this.can_generate="undefined"==typeof e||e},this.set_maximum_replay_time_difference=function(e){this.maximum_replay_time_difference=parseInt(e)},this.set_debug_level=function(e){this.debug_level="undefined"!=typeof e?e:1,this.debug_level&&console.log("UDRPC: Debug mode activated (level: "+e+")")},this.ensure_crypto_loaded=function(){if("undefined"==typeof forge)throw console.log("UDRPC JS: No loaded forge library found (you should make sure it has loaded before calling UDRPC functions)"),"No loaded forge library found (you should make sure it has loaded before calling UDRPC functions)"},this.set_destination_url=function(e){this.destination_url=e},this.set_message_wrapper=function(e){this.message_wrapper=e},this.set_message_unwrapper=function(e){this.message_unwrapper=e},this.set_option_name=function(e){console.log("UDRPC: set_option_name() called - which is wrong/unnecessary in the JavaScript port")},this.get_key_remote=function(){return!this.key_remote&&this.can_generate&&this.generate_new_keypair(),!!this.key_remote&&this.key_remote},this.set_key_remote=function(e){this.key_remote=e},this.get_key_local=function(){return!this.key_local&&this.can_generate&&this.generate_new_keypair(),!!this.key_local&&this.key_local},this.decode_portable_bundle=function(e,t){return t="undefined"!=typeof t?t:"raw",this.unimplemented_function("decode_portable_bundle"),!1},this.get_portable_bundle=function(e){return e="undefined"!=typeof e?e:"raw",this.unimplemented_function("get_portable_bundle"),!1},this.set_key_local=function(e){this.key_local=e},this.unimplemented_function=function(e){console.log("UDRPC: Unimplemented function in JavaScript port called: "+e)},this.generate_new_keypair=function(){return this.unimplemented_function("generate_new_keypair"),!1},this.encrypt_message=function(e,t,s){if(t="undefined"!=typeof t&&t,!t&&!this.key_remote)throw"No encryption key has been set";t||(t=this.key_remote),this.ensure_crypto_loaded();var r=forge.pki.publicKeyFromPem(t);if("undefined"==typeof s){var o=Math.ceil(r.n.bitLength()/8);s=o<65?16:32}var n=forge.random.getBytesSync(s);this.debug_level>1&&console.log("Generated symmetric key, in hex: "+forge.util.bytesToHex(n));var i=forge.cipher.createCipher("AES-CBC",n);i.start({iv:""}),i.update(forge.util.createBuffer(forge.util.encodeUtf8(e))),i.finish();var a=i.output;this.debug_level>1&&console.log("Ciphertext, in hex (PHP equiv: bin2hex): "+forge.util.bytesToHex(a)),a=forge.util.encode64(a.bytes()),this.debug_level>1&&console.log("Ciphertext, in base64: "+a),n=r.encrypt(n,"RSA-OAEP"),this.debug_level>1&&console.log("Symmetric key, after being encrypted with the assymetric key, in hex: "+forge.util.bytesToHex(n)),n=forge.util.encode64(n),this.debug_level>1&&console.log("Encrypted symmetric key, in base 64: "+n);var l=n.length;this.debug_level>1&&console.log("Key length (decimal): "+l),l=l.toString(16),l=this.paddingleft("000",l);var h=a.length;return this.debug_level>1&&console.log("Cipher length (decimal): "+h),h=h.toString(16),h=this.paddingleft("0000000000000000",h),this.debug_level>1&&(console.log("Length, hexed + padded (3): "+l),console.log("Cipherlength, hexed + padded (16): "+h)),l+n+h+a},this.decrypt_message=function(e){if(!this.key_local)throw new Exception("No decryption key has been set");this.ensure_crypto_loaded();var t=e.substr(0,3);this.debug_level>1&&console.log("Key length (hex + passed): "+t),t=parseInt(t,16),this.debug_level>1&&console.log("Key length (decimal): "+t);var s=e.substr(3,t);this.debug_level>1&&console.log("Encrypted symmetric key, base64-encoded: "+s),s=forge.util.decode64(s),this.debug_level>1&&console.log("Encrypted symmetric key, in hex: "+forge.util.bytesToHex(s));var r=e.substr(t+3,16);this.debug_level>1&&console.log("Ciphertext length (hex + passed): "+r),r=parseInt(r,16),this.debug_level>1&&console.log("Ciphertext length (decimal): "+r);var o=e.substr(t+19,r);this.debug_level>1&&console.log("Ciphertext (base64): "+o),o=forge.util.decode64(o),this.debug_level>1&&console.log("Ciphertext, in hex (PHP equiv: bin2hex): "+forge.util.bytesToHex(o));var n=forge.pki.privateKeyFromPem(this.key_local);this.debug_level>1&&console.log("Attempting to decrypt symmetric key");var s=n.decrypt(s,"RSA-OAEP");this.debug_level>1&&console.log("Generated symmetric key, after being decrypted, in hex: "+forge.util.bytesToHex(s));var i=forge.cipher.createDecipher("AES-CBC",s);return i.start({iv:""}),i.update(forge.util.createBuffer(o)),i.finish(),forge.util.decodeUtf8(i.output)},this.create_message=function(e,t,s,r,o){r="undefined"!=typeof r&&r,o="undefined"!=typeof o&&o,t="undefined"!=typeof t?t:null,s="undefined"!=typeof s&&s;var n={};s?n.response=e:n.command=e,this.cors_headers_wanted&&(n.cors_headers_wanted=1),n.time=this.time_now(),n.key_name=this.key_name_indicator,this.message_random_number=Math.round(2147483647*Math.random()),n.rand=this.message_random_number,null!==t&&(n.data=t);var i=this.encrypt_message(JSON.stringify(n),r),a={format:this.format,key_name:this.key_name_indicator,udrpc_message:i,signature:this.signature_for_message(i,o)},l=a;return this.message_wrapper!==!1&&(l=this.message_wrapper,l.wrapped_message=a),l},this.signature_for_message=function(e,t){if(t="undefined"!=typeof t&&t,!t&&!this.key_local)throw"No encryption key (local) has been set";t||(t=this.key_local),this.ensure_crypto_loaded();var s="sha256",r=forge.md.sha256.create();r.update(e,"utf8");var o=forge.pki.privateKeyFromPem(t),n=o.sign(r,"RSASSA-PKCS1-V1_5"),i=forge.util.encode64(n);return this.debug_level>0&&(console.log("Hash ("+s+") (follows)"),console.log(r),this.debug_level>1&&(console.log("Signature (raw): "+n),console.log("Signature (base64-ed): "+i))),i},this.verify_signature=function(e,t,s,r){r="undefined"!=typeof r&&"sha256",this.ensure_crypto_loaded();var o=forge.md.sha256.create();o.update(e,"utf8");var n=o.digest().bytes(),i=forge.pki.publicKeyFromPem(s);this.debug_level>1&&(console.log("UDRPC: verify_signature: message hash (hex): "+forge.util.bytesToHex(n)),console.log("UDRPC: verify_signature: signature (len="+t.length+") (existing base64): "+t));var a=i.verify(n,forge.util.decode64(t));return this.debug_level>0&&console.log("UDRPC: verify signature: result: "+a),a},this.activate_replay_protection=function(e){this.extra_replay_protection="undefined"==typeof e||e},this.set_http_credentials=function(e){this.http_credentials=e},this.set_auth_method=function(e){this.auth_method=e},this.send_post=function(e,t,s,r,o){o="undefined"!=typeof o?o:30,t&&jQuery(t).addClass("updraftcentral_spinner");try{this.debug_level>0&&console.log("send_post: "+e);var n={type:"POST",url:e,data:s,dataType:"text",headers:{"X-Secondary-User-Agent":"class-udrpc.js/"+this.version},timeout:1e3*o,success:function(e){t&&jQuery(t).removeClass("updraftcentral_spinner"),r.call(this,e)},error:function(s,o,n){if(console.log("UDRPC: Error in send_post (url="+e+")"),console.log(s),console.log(o),console.log(n),t&&jQuery(t).removeClass("updraftcentral_spinner"),""==n&&(n="http_post_fail"),n.hasOwnProperty("statusText")&&(n=n.statusText.toString()),"function"==typeof n.toLowerCase)n=n.toLowerCase();else try{var i=n.toString().toLowerCase();i&&(n=i)}catch(a){}r.call(this,s,"error",n)}};if(this.http_credentials.hasOwnProperty("username")){var i=this.http_credentials.hasOwnProperty("password")?this.http_credentials.password:"";"manual"==this.auth_method?n.headers.Authorization="Basic "+forge.util.encode64(this.http_credentials.username+":"+i):(n.xhrFields={withCredentials:!0},n.username=this.http_credentials.username,this.http_credentials.hasOwnProperty("password")&&(n.password=this.http_credentials.password))}this.debug_level>1&&(console.log("UDPRC: jQuery POST: options follow:"),console.log(n)),jQuery.ajax(n)}catch(a){throw console.log("UDRPC: Exception in send_post (url="+e+")"),console.log(a),a}},this.send_message=function(e,t,s,r){if(t="undefined"!=typeof t?t:null,s="undefined"!=typeof s?s:30,!this.destination_url)throw console.log("UDRPC: send_message: no destination URL has been initialised"),"RPC error: destination URL not initialised";message=this.create_message(e,t,!1);var o=this.message_random_number,n=this;this.send_post(this.destination_url,!1,message,function(e,t,s){if("error"==t)return void r.call(this,e,"error",s);if(""===e)return console.log("UDRPC: the response from the remote site was empty"),void r.call(this,e,"error","response_empty");try{var i=jQuery.parseJSON(e)}catch(a){return console.log(a),void r.call(this,e,"error","json_parse_fail")}try{if(!i)return console.log("UDRPC: the response from the remote site was empty"),console.log(e),void r.call(this,e,"error","parsed_response_not_understood");if(!1!==n.message_unwrapper){var l=n.message_unwrapper.call(this,i);if(!1===l)return void r.call(this,i,"error","unwrapper_failure");i=l}if(!i.hasOwnProperty("udrpc_message"))return console.log("UDRPC: the response from the remote site could not be understood (follows)"),console.log(e),void r.call(this,e,"error","parsed_response_not_understood");if(!i.hasOwnProperty("signature")||!i.signature)return console.log("UDRPC: No signature found on response from remote site - message dropped"),void r.call(this,i,"error","response_no_signature");try{if(!n.verify_signature(i.udrpc_message,i.signature,n.key_remote))return console.log("UDRPC: Verify signature on response: failed - message dropped"),void r.call(this,i,"error","response_signature_invalid");n.debug&&console.log("UDRPC: Verify signature on response: OK")}catch(a){return console.log(a),void r.call(this,i,"error","signature_verify_exception")}try{var h=n.decrypt_message(i.udrpc_message)}catch(a){return console.log(a),void r.call(this,a,"error","decryption_error")}var d=jQuery.parseJSON(h);if(!d.hasOwnProperty("response")||!d.hasOwnProperty("time"))return console.log("response_corrupt: Response from remote site was not in the expected format (follows)"),console.log(i),console.log(d),void r.call(this,h,"error","parsed_response_bad_format");if(n.extra_replay_protection&&(message_hash=n.calculate_message_hash(e),n.message_hash_seen(message_hash)))return console.log("Message refused: replay detected"),console.log(message_hash),void r.call(this,d.response,"error","response_replay_detected");var c=n.time_now();if(time_difference=c-d.time,time_difference>n.maximum_replay_time_difference)return console.log("UDRPC: Message refused: too late - diff="+time_difference+", maximum_difference="+n.maximum_replay_time_difference),void r.call(this,d.response,"error","response_refused_too_late");if(d.hasOwnProperty("incoming_rand")&&o&&d.incoming_rand!=o)return console.log("UDRPC: Message mismatch (possibly MITM) (sent_rand="+o+", returned_rand="+d.incoming_rand+"): dropping"),void r.call(this,d.response,"error","response_mismatch")}catch(a){return console.log(a),void r.call(this,i,"error","js_exception")}r.call(this,d,"ok")},s)},this.create_listener=function(){return this.unimplemented_function("create_listener"),!1},this.calculate_message_hash=function(e){this.ensure_crypto_loaded();var t=forge.md.sha256.create();return t.update(e),t.digest().toHex()},this.message_hash_seen=function(e){var t=this.seen_hashes,s=this.time_now(),r=!1,o=!1;return jQuery.each(t,function(n,i){var a=t.hash;a<s-this.maximum_replay_time_difference?(r=!0,delete t.hash):i==e&&(o=!0,r=!0,t.hash=s)}),o},this.set_key_name_indicator(e),this};