function UpdraftCentral_PrevNext_Paginator(e,t,r){function a(){t.is_paged&&(t.prev_key.length>0||t.next_key.length>0)&&l(e)}function n(){d=t.next_key,s+=","+t.prev_key,p()}function i(){markers=s.split(","),d=markers[markers.length-1],s=s.replace(","+d,""),p()}function l(e){f.element=jQuery(UpdraftCentral.template_replace("updraftvault-prevnext-paginator",{})),0==t.prev_key.length&&(f.element.find("a.page_prev").parent("li").hide(),f.element.find('li:contains("|")').hide()),0==t.next_key.length&&(f.element.find("a.page_next").parent("li").hide(),f.element.find('li:contains("|")').hide()),f.element.appendTo(e),f.element.on("click","a",function(e){e.preventDefault(),jQuery(this).hasClass("page_prev")?i():jQuery(this).hasClass("page_next")&&n()})}function p(){f.element.trigger("page_change",d,s),jQuery.isFunction(u)&&u(d,s)}var f=this,u=r,d="",s=t.last_marker;a(),this.page_change=function(e){u=e}}function UpdraftCentral_UpdraftVault_Management(){function e(t,r){var a=t.find(".updraftcentral_updraftvault_paginator");if(0===a.length){var n=t.find(".updraftcentral_row_extracontents");a=jQuery('<div class="updraftcentral_updraftvault_paginator"></div>').appendTo(n)}else a.empty();var i=new UpdraftCentral_PrevNext_Paginator(a,r);i.page_change(function(r,a){var n={bucket:u,prefix:d,marker_key:r,last_marker:a,per_page:t.find(".updraftcentral_updraftvault_header .per_page").val()};s.browse_files(t,n).then(function(r){"undefined"!=typeof r.paging&&e(t,{prev_key:r.paging.prev_key,next_key:r.paging.next_key,is_paged:r.paging.is_paged,last_marker:r.paging.last_marker})})})}function t(e){var t=jQuery.Deferred();"undefined"==typeof e.per_page&&(e.per_page=10),"undefined"==typeof e.marker_key&&(e.marker_key=""),"undefined"==typeof e.last_marker&&(e.last_marker="");var r={Bucket:e.bucket,Delimiter:"/",Marker:e.marker_key,MaxKeys:e.per_page,Prefix:e.prefix};return f.listObjects(r,function(r,n){if(r)t.reject({error:!0,message:"general_error_response",values:[r.stack]});else{for(var i,l,p,u,d,s=e.marker_key,_="",o=!0,c=[],g=n.Contents,v=0;v<g.length;v++)l=g[v].Key,p=l.replace(e.prefix,""),u=a(g[v].Size,2),d={Bucket:e.bucket,Key:l},e.prefix!==l&&c.push({key:l,file_name:p,size:u,download_link:f.getSignedUrl("getObject",d)});c.length&&(n.IsTruncated?_=n.NextMarker:0===s.length&&(o=!1)),i={prev_key:s,next_key:_,is_paged:o,last_marker:e.last_marker},c.length?t.resolve({files:c,data:n,paging:i}):t.resolve({error:!1,message:"files_not_found",values:[]})}}),t.promise()}function r(e){var t=jQuery.Deferred();files=[];for(var r=0;r<e.files.length;r++)key=e.files[r],files.push({Key:key});var a={Bucket:e.bucket,Delete:{Objects:files}};return f.deleteObjects(a,function(e,r){e?t.reject({error:!0,message:"delete_error",values:[e.stack]}):t.resolve({error:!1,message:"delete_success",values:[]})}),t.promise()}function a(e,t){if(0===e)return"0 Bytes";var r=["Bytes","KB","MB","GB","TB"],a=1e3,n=t||3,i=Math.floor(Math.log(e)/Math.log(a));return parseFloat((e/Math.pow(a,i)).toFixed(n))+" "+r[i]}function n(e){UpdraftCentral.set_loading(e.container),"undefined"!=typeof e.aws_request&&e.container.before('<div class="updraftcentral_spinner"></div>')}function i(e){var t=jQuery.Deferred();return UpdraftCentral.done_loading(e.container,e.html).then(function(){"undefined"!=typeof e.aws_request&&e.container.parent().children(".updraftcentral_spinner").remove(),t.resolve()}),t.promise()}function l(e,t){var r={bucket:"",prefix:"",region:""};if("undefined"!=typeof e){var a=e.split("/");a.length&&(r.bucket=a[0],r.region=r.bucket.replace(t+"-",""),a.length>1&&(r.prefix=e.replace(r.bucket+"/","")+"/"))}return r}function p(e){var t;if("string"!=typeof e&&e&&e.hasOwnProperty("values")&&(t=e.values,e=e.message),"undefined"==typeof e&&console.log("UpdraftCentral: The 'translate_message' requires an object with the properties 'message' and 'values' if there's a variable"),e===!1)return"";var r=udclion.updraftvault[e];return"undefined"==typeof r?(UpdraftCentral_Library.dialog.alert("<h2>"+udclion.error+"</h2><p>"+sprintf(udclion.updraftvault.translation_not_found_for,e)+"</p>"),null):"undefined"==typeof t?r:sprintf(r,t)}var f,u,d,s=this;jQuery("#updraftcentral_dashboard_existingsites").on("updraftcentral_dashboard_mode_set_updraftvault",function(){UpdraftCentral.register_row_clicker('.updraftcentral_updraftvault_table input[name="uc_updraftvault_check_all"]',function(e){var t=!1;jQuery(this).is(":checked")&&(t=!0),e.find(".updraftcentral_updraftvault_table input.check_item").each(function(){jQuery(this).prop("checked",t)})},!0,"change"),UpdraftCentral.register_row_clicker("select.per_page",function(t){if(t.find(".updraftcentral_updraftvault_rows.no-matched").is(":visible"))return!1;var r={bucket:u,prefix:d,per_page:t.find(".updraftcentral_updraftvault_header .per_page").val()};s.browse_files(t,r).then(function(r){"undefined"!=typeof r.paging&&e(t,{prev_key:r.paging.prev_key,next_key:r.paging.next_key,is_paged:r.paging.is_paged,last_marker:r.paging.last_marker})})},!0,"change"),UpdraftCentral.register_row_clicker(".updraftcentral_site_updraftvault_action_btn",function(e){if(e.find(".updraftcentral_updraftvault_rows.no-matched").is(":visible"))return!1;var t=jQuery(this).data("action");switch(t){case"delete":var r={bucket:u,prefix:d,files:[]};e.find(".updraftcentral_updraftvault_table input.check_item:checked").each(function(){r.files.push(jQuery(this).data("key"))}),r.files.length>0?UpdraftCentral_Library.dialog.confirm("<h2>"+p("delete_files")+"</h2><p>"+p("delete_files_confirm")+"</p>",function(t){t&&s.delete_files(e,r)}):UpdraftCentral_Library.dialog.alert("<h2>"+p("empty_selection_header")+"</h2><p>"+p("select_files")+"</p>")}},!0),UpdraftCentral.register_row_clicker(".updraftcentral_site_browse_files",function(t){s.get_updraftvault_credentials(t).then(function(r){var a=l(r.path,r.key);AWS.config.update({accessKeyId:r.accesskey,secretAccessKey:r.secretkey}),AWS.config.region=a.region,f=new AWS.S3,u=a.bucket,d=a.prefix;var n={bucket:a.bucket,prefix:a.prefix,per_page:10,marker_key:"",last_marker:""};s.get_updraftvault_filters(t),s.browse_files(t,n).then(function(r){"undefined"!=typeof r.paging&&e(t,{prev_key:r.paging.prev_key,next_key:r.paging.next_key,is_paged:r.paging.is_paged,last_marker:r.paging.last_marker})})})},!0)}),this.browse_files=function(e,r){var a=jQuery.Deferred(),l=e.find(".updraftcentral_row_extracontents"),f=l.find(".updraftcentral_updraftvault_rows");0===f.length&&(f=jQuery('<div class="updraftcentral_updraftvault_rows"></div>').appendTo(l));var u={container:f,html:"",aws_request:!0};return n(u),t(r).then(function(e){u.html=UpdraftCentral.template_replace("updraftvault-updraftvault-row",e),"undefined"!=typeof e.message&&(u.html=p(e)),u.response=e}).fail(function(e){UpdraftCentral_Library.dialog.alert("<h2>"+p("browse_failed_header")+"</h2><p>"+p(e)+"</p>"),u.response=e}).always(function(e){"undefined"==typeof e&&(e=u.response),i(u).then(function(){"undefined"!=typeof e.files?jQuery.isArray(e.files)&&jQuery(".updraftcentral_updraftvault_rows").removeClass("no-matched"):"undefined"!=typeof e.message&&"files_not_found"===e.message&&jQuery(".updraftcentral_updraftvault_rows").addClass("no-matched"),a.resolve(e)})}),a.promise()},this.delete_files=function(t,a){var l=t.find(".updraftcentral_row_extracontents"),f=l.find(".updraftcentral_updraftvault_rows");0===f.length&&(f=jQuery('<div class="updraftcentral_updraftvault_rows"></div>').appendTo(l));var u={container:f,html:"",aws_request:!0};n(u),r(a).then(function(r){var n=r;s.browse_files(t,a).then(function(r){"undefined"!=typeof r.paging&&e(t,{prev_key:r.paging.prev_key,next_key:r.paging.next_key,is_paged:r.paging.is_paged,last_marker:r.paging.last_marker}),UpdraftCentral_Library.dialog.alert("<h2>"+p("delete_success_header")+"</h2><p>"+p(n)+"</p>")})}).fail(function(e){UpdraftCentral_Library.dialog.alert("<h2>"+p("delete_failed_header")+"</h2><p>"+p(e)+"</p>"),i(u)})},this.get_updraftvault_filters=function(e){var t=jQuery.Deferred(),r=e.find(".updraftcentral_row_extracontents"),a=r.find(".updraftcentral_updraftvault_filters");0===a.length&&(a=jQuery('<div class="updraftcentral_updraftvault_filters"></div>').prependTo(r));var l={container:a,html:""};n(l);var p={paging:{per_page_options:[10,20,50,100,500,1e3]}};return l.html=UpdraftCentral.template_replace("updraftvault-updraftvault-filter",p),i(l).then(function(){t.resolve()}),t.promise()},this.get_updraftvault_credentials=function(e){var t=jQuery.Deferred(),r=e.find(".updraftcentral_row_extracontents"),a=r.find(".updraftcentral_updraftvault_rows");0===a.length&&(a=jQuery('<div class="updraftcentral_updraftvault_rows"></div>').appendTo(r));var l={container:a,html:""};return n(l),UpdraftCentral.send_site_rpc("updraftvault.get_credentials",null,e,function(e,r){"ok"!==r||e.data.error?(UpdraftCentral_Library.dialog.alert("<h2>"+p("connection_error_header")+"</h2><p>"+p(e.data)+"</p>"),i(l),t.reject()):(l.html=UpdraftCentral.template_replace("updraftvault-updraftvault-row",e.data),i(l).then(function(){t.resolve(e.data)}))}),t.promise()}}jQuery(document).ready(function(){new UpdraftCentral_UpdraftVault_Management});